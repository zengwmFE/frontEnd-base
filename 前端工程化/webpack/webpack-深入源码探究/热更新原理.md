## çƒ­æ¨¡å—æ›´æ–°åŸç†

### çƒ­æ¨¡å—æ›´æ–°çš„æ–¹æ³•
> `Hot Module Replacement`ç®€ç§°`HMR`ï¼Œå¯ä»¥é€šè¿‡ä¸åˆ·æ–°æ•´ä¸ªé¡µé¢ï¼Œåªä¿®æ”¹æ”¹å˜äº†çš„æ¨¡å—ã€‚`HMR`ä½œä¸º`webpack`å†…ç½®çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡ï¼š1. å‘½ä»¤è¡Œè®¾ç½®--hotæ¥å®ç°ï¼›2. é€šè¿‡`HotModuleReplacementPlugin`æ¥å®ç°ã€‚

### å¯åŠ¨webpack-dev-server
#### æ ¹æ®`webpack`å†…çš„`package.json`ä¸­:
```
"bin": {
    "webpack-dev-server": "bin/webpack-dev-server.js"
  },
```
å¯ä»¥çŸ¥é“webpackçš„èµ·å§‹æ–‡ä»¶:`bin/webpack-dev-server.js`

#### å®ä¾‹åŒ–webpackï¼Œç”Ÿæˆcompiler,å¯åŠ¨ç¼–è¯‘çš„è¿‡ç¨‹
 
```
compiler = webpack(config);

```
#### å¯åŠ¨æœåŠ¡

```javascript
// å¯åŠ¨æœåŠ¡
server = new Server(compiler, options, log);
serverData.server = server;

 if (options.socket) {
    server.listeningApp.on('error', (e) => {
      if (e.code === 'EADDRINUSE') {
        const client``Socket = new net.Socket();

        clientSocket.on('error', (err) => {
          if (err.code === 'ECONNREFUSED') {
            // No other server listening on this socket so it can be safely removed
            fs.unlinkSync(options.socket);

            server.listen(options.socket, options.host, (error) => {
              if (error) {
                throw error;
              }
            });
          }
        });

        clientSocket.connect({ path: options.socket }, () => {
          throw new Error('This socket is already used');
        });
      }
    });

    server.listen(options.socket, options.host, (err) => {...});
  } else {
    server.listen(options.port, options.host, (err) => {
      if (err) {
        throw err;
      }
    });
  }
```

#### æœ¬åœ°æœåŠ¡ä»£ç 
```javascript
// '../lib/Server'
class Server{
  constructor(){
    //
    this.setupHooks();
    this.setupApp();
    // æ¯æ¬¡åˆå§‹åŒ–ä¹‹å‰éƒ½è¦å…ˆæŠŠåŸæœ‰çš„è¿›ç¨‹ç»™æ€æ‰
    killable(this.listeningApp);
    ...
    // åˆ›å»ºæœåŠ¡
     this.createServer();
  }
}
```

1. ç¬¬äºŒæ­¥ï¼Œåˆå§‹åŒ–`express`
```javascript
  setupApp() {
    this.app = new express();
  }

```
2. åˆ›å»ºæœåŠ¡ï¼Œåˆ†ä¸ºä¸¤æ­¥ï¼Œ
  - å…ˆåˆ›å»ºäº†æœ¬åœ°`server`,å›è°ƒç»§ç»­åˆ›å»ºä¸€ä¸ª`websocketæœåŠ¡`ï¼Œå·²å®ç°å½“æœ¬åœ°ä»£ç å‘ç”Ÿæ”¹å˜äº†ï¼Œèƒ½å¤Ÿç¬¬ä¸€æ—¶é—´å°†æ›´æ–°åçš„ä»£ç æ¨é€åˆ°æµè§ˆå™¨äº†

```javascript
  // ç„¶ååœ¨å®ä¾‹åŒ–serverè°ƒç”¨listenï¼Œåœ¨webpack-dev-serveræ–‡ä»¶ä¸­è°ƒç”¨
  
  listen(port, hostname, fn) {
    this.hostname = hostname;

    return this.listeningApp.listen(port, hostname, (err) => {
      this.createSocketServer();

      if (this.options.bonjour) {
        runBonjour(this.options);
      }

      this.showStatus();

      if (fn) {
        fn.call(this.listeningApp, err);
      }

      if (typeof this.options.onListening === 'function') {
        this.options.onListening(this);
      }
    });
  }
  // 1. å…ˆæ‰§è¡Œäº†createServeråˆ›å»ºäº†æœåŠ¡å®ä¾‹
  createServer() {
      this.listeningApp = http.createServer(this.app);
  }
```

æ€»ç»“æ¥è¯´ï¼š
ç®€å•åˆ†æè¿™ç¬¬ä¸€éƒ¨åˆ†ï¼Œ`webpack`åšäº†è¿™ä¹ˆå‡ ä»¶äº‹
1. é¦–å…ˆå¯åŠ¨äº†`webpack`ï¼Œç”Ÿæˆ`compiler`å®ä¾‹
2. é€šè¿‡`express`(ä¸ºä»€ä¹ˆä¸ä½¿ç”¨koa2ï¼Ÿ)ï¼Œåˆ›å»ºä¸€ä¸ªæœ¬åœ°æœåŠ¡å™¨ï¼Œè®©æµè§ˆå™¨èƒ½å¤Ÿåœ¨æœ¬åœ°ä»¥`ip`(ä¸¾ä¸ªğŸŒ°)çš„è®¿é—®ç”Ÿæˆçš„æ–‡ä»¶
3. å¯åŠ¨å®Œäº†æœ¬åœ°æœåŠ¡åï¼Œå†ä¼šå»åˆ›å»ºä¸€ä¸ª`websocket`æœåŠ¡å™¨ï¼Œä»¥ä¾¿æœ¬åœ°æ–‡ä»¶å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œèƒ½å¤ŸåŠæ—¶çš„é€šçŸ¥åˆ°æµè§ˆå™¨ç«¯ã€‚


### è¯¦ç»†çš„çœ‹ä¸€ä¸‹è¿™æ®µå†…å®¹åšäº†ä»€ä¹ˆäº‹å§

åˆšæ‰ç¬¬ä¸€éƒ¨åˆ†çš„åˆ†æï¼Œäº†è§£äº†å¤§æ¦‚çš„æµç¨‹ï¼Œå†æ¥åˆ†æä¸‹å…¶ä¸­å…·ä½“è¿˜åšäº†é‚£äº›äº‹
#### ä¿®æ”¹entryçš„è·¯å¾„
åœ¨å¯åŠ¨æœ¬åœ°æœåŠ¡å‰ï¼Œ
```
 updateCompiler(this.compiler, this.options);
 // const updateCompiler = require('./utils/updateCompiler');

```
åœ¨`updateCompiler.js`
åšäº†ä¸¤ä»¶äº‹:
1. è·å–æœ¬åœ°çƒ­æ›´æ–°ä»£ç çš„è·¯å¾„
2. è·å–`websocket`å®¢æˆ·ç«¯è·¯å¾„
```
addEntries(webpackConfig, options);
```

**addEntries**
```
    // websocket å®¢æˆ·ç«¯è·¯å¾„
    const clientEntry = `${require.resolve(
      '../../client/'
    )}?${domain}${sockHost}${sockPath}${sockPort}`;
    // çƒ­æ›´æ–°è·¯å¾„
    if (options.hotOnly) {
      hotEntry = require.resolve('webpack/hot/only-dev-server');
    } else if (options.hot) {
      hotEntry = require.resolve('webpack/hot/dev-server');
    }
```

> require.resolveçš„ä½œç”¨ï¼šä½¿ç”¨å†…éƒ¨çš„`require()`æœºåˆ¶æŸ¥è¯¢æ¨¡å—çš„ä½ç½®ï¼Œæ­¤æ“ä½œåªè¿”å›è§£æåçš„æ–‡ä»¶åï¼Œä¸ä¼šåŠ è½½è¯¥æ¨¡å—ã€‚å¦‚æœæ‰¾ä¸åˆ°æ¨¡å—ï¼Œåˆ™ä¼šæŠ›å‡º`MODULE_NOT_FOUND`é”™è¯¯ã€‚

æœ€åå°†è¿™æ®µç”Ÿæˆçš„`clientEntry`å’Œ`hotEntry`,ç”Ÿæˆ`additionalEntriesï¼ˆé¢å¤–å…¥å£ï¼‰`,æœ€åç”Ÿæˆæ–°çš„entry

```javascript
const additionalEntries = checkInject(
        options.injectClient,
        config,
        webTarget
      )
        ? [clientEntry]
        : [];

      if (hotEntry && checkInject(options.injectHot, config, true)) {
        additionalEntries.push(hotEntry);
      }

      config.entry = prependEntry(config.entry || './src', additionalEntries);
```

**å¾—åˆ°å¦‚ï¼š**
```javascript
// ä¿®æ”¹åçš„entryå…¥å£
{ entry:
    { index: 
        [
            // ä¸Šé¢è·å–çš„clientEntry
            'xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080',
            // ä¸Šé¢è·å–çš„hotEntry
            'xxx/node_modules/webpack/hot/dev-server.js',
            // å¼€å‘é…ç½®çš„å…¥å£
            './src/index.js'
    	],
    },
}      

```

å¯ä»¥çŸ¥é“ï¼Œåœ¨å®ä¾‹åŒ–æœåŠ¡ä¹‹å‰å°±ä¼šå¾€`entry`å¢åŠ äº†ä¸¤ä¸ªå…¥å£æ–‡ä»¶ï¼Œè€Œè¿™ä¸¤ä¸ªå…¥å£æ–‡ä»¶ä¹Ÿä¼šè¢«æ‰“åŒ…åˆ°æœ€åç”Ÿæˆçš„`bundle`é‡Œé¢ï¼ˆ**å‚è€ƒwebpackå¤šå…¥å£æ‰“åŒ…**ï¼‰


#### ç›‘å¬æ¯æ¬¡webpackç¼–è¯‘å®Œæˆ
**this.setupHooks**
```javascript
 setupHooks() {
      const { compile, done } = compiler.hooks;

      compile.tap('webpack-dev-server', invalidPlugin);
      done.tap('webpack-dev-server', (stats) => {
        this._sendStats(this.sockets, this.getStats(stats));
        this._stats = stats;
      });
    };
  }
```
ç»™`done`ç»‘å®šäº†ä¸€ä¸ªåŒæ­¥é’©å­ï¼Œç›‘å¬ç¼–è¯‘å®Œæˆï¼Œç„¶åæ‰§è¡Œ`this._sendStats`
```
  _sendStats(sockets, stats, force) {
      this.sockWrite(sockets, 'hash', stats.hash);
      this.sockWrite(sockets, 'ok');
  }

```
æ¯å½“`webpack`ç¼–è¯‘å®Œæˆä¸€æ¬¡ï¼Œå°±ä¼šç»™æµè§ˆå™¨å‘é€ä¸€ä¸ª`hash`æŒ‡ä»¤ï¼Œå°†å¯¹åº”ç¼–è¯‘çš„`hash`å€¼ï¼ŒåŒæ—¶å‘é€ä¸€ä¸ª`ok`çš„æŒ‡ä»¤ï¼Œè¿™æ ·æµè§ˆå™¨å¯ä»¥å°†æœ€æ–°çš„`hash`è¿›è¡Œä½¿ç”¨

#### webpackç›‘å¬æ–‡ä»¶æ›´æ”¹
ä¿®æ”¹ä»£ç ï¼Œå°±ä¼šè§¦å‘ç¼–è¯‘ï¼Œè¿˜éœ€è¦ç›‘å¬æœ¬åœ°ä»£ç çš„å˜åŒ–ï¼Œä¸»è¦æ˜¯é€šè¿‡`setupDevMiddleware`æ–¹æ³•å®ç°çš„ã€‚
1. å› ä¸º`webpack-dev-server`åªè´Ÿè´£å¯åŠ¨æœåŠ¡å’Œå‰ç½®å‡†å¤‡å·¥ä½œï¼Œæ‰€æœ‰æ–‡ä»¶ç›¸å…³çš„æ“ä½œéƒ½æ”¾åˆ°äº†`webpack-dev-middleware`ï¼Œä¸»è¦æ˜¯è´Ÿè´£æœ¬åœ°æ–‡ä»¶çš„ç¼–è¯‘å’Œè¾“å‡ºä»¥åŠç›‘å¬ã€‚
```
  setupDevMiddleware() {
    // middleware for serving webpack bundle
    this.middleware = webpackDevMiddleware(
      this.compiler,
      Object.assign({}, this.options, { logLevel: this.log.options.level })
    );
  }
```

```
// node_modules/webpack-dev-middleware/index.js
compiler.watch(options.watchOptions, (err) => {
    if (err) {...}
});

// é€šè¿‡â€œmemory-fsâ€åº“å°†æ‰“åŒ…åçš„æ–‡ä»¶å†™å…¥å†…å­˜
setFs(context, compiler); 

```
- è°ƒç”¨`compiler.watch`
 - é¦–å…ˆå¯¹æœ¬åœ°æ–‡ä»¶è¿›è¡Œç¼–è¯‘æ‰“åŒ…ï¼Œè¿›è¡Œä¸€æ®µ`webpack`çš„ç¼–è¯‘
 - ç¼–è¯‘ç»“æŸçš„æ—¶å€™ï¼Œå¼€å¯å¯¹æœ¬åœ°æ–‡ä»¶çš„ç›‘å¬ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œç»§ç»­è¿›è¡Œ`webpack`ç¼–è¯‘ï¼Œ`compiler.watch`è¿™ä¸ªæ–¹æ³•ã€‚ç›‘å¬æœ¬åœ°æ–‡ä»¶çš„å˜åŒ–å¯ä»¥é€šè¿‡**æ–‡ä»¶çš„ç”Ÿæˆæ—¶é—´**æ˜¯å¦æœ‰å˜åŒ–ã€‚
- æ‰§è¡Œ`setFs`ï¼Œä¸»è¦æ˜¯ç›®çš„å°±æ˜¯å°†ç¼–è¯‘åçš„æ–‡ä»¶æ‰“åŒ…åˆ°å†…å­˜ã€‚æ‰€ä»¥è¯´åœ¨æ–‡ä»¶å¤¹æ²¡æœ‰å‘ç°`dist`ç›®å½•ï¼Œè¿™ä¸ªæ—¶å€™æ–‡ä»¶éƒ½åœ¨å†…å­˜ä¸­ï¼Œå› ä¸ºç›´æ¥è®¿é—®å†…å­˜ä¸­çš„æ–‡ä»¶è¦æ¯”ç›´æ¥è®¿é—®æœ¬åœ°æ–‡ä»¶è¦å¿«ï¼Œè€Œä¸”å¯ä»¥å‡å°‘å†™å…¥æ–‡ä»¶çš„å¼€é”€ï¼Œè¿™ä¸€åˆ‡éƒ½è¦ç”¨`memory-fs`

#### æµè§ˆå™¨æ¥æ”¶åˆ°çƒ­æ›´æ–°çš„é€šçŸ¥

åœ¨`done.tap('webpack-dev-server',function(){...})`ä¸­ï¼Œè°ƒç”¨äº†
```
this.sockWrite(sockets, 'hash', stats.hash);
this.sockWrite(sockets, 'ok');
```

```
// sockWrite
sockWrite(sockets, type, data) {
    sockets.forEach((socket) => {
      this.socketServer.send(socket, JSON.stringify({ type, data }));
    });
}
```
æ¥å‘é€ä¸åŒçš„`socket`çš„å‘½ä»¤ï¼š`hash`,`ok`
æœ€åå†™å…¥åˆ°`webpack-dev-server/client/index.js`æ–‡ä»¶ä¸­ï¼Œ

**socketæ¥æ”¶**
```
var onSocketMessage = {
  hash: function hash(_hash) {
        // æ›´æ–°è¦ä¼ è¾“ç»™æµè§ˆå™¨çš„hashå€¼
        status.currentHash = _hash;
    },
    ok: function ok() {
        sendMessage('Ok');
        // è¿›è¡Œæ›´æ–°æ£€æŸ¥ç­‰æ“ä½œ
        reloadApp(options, status);
    },
}

// ./util/reloadApp
function reloadApp(_ref, _ref2) {
    var hotEmitter = require('webpack/hot/emitter');
    hotEmitter.emit('webpackHotUpdate', currentHash);
}
```
æµè§ˆå™¨æ¥æ”¶çƒ­æ›´æ–°é€šçŸ¥ä¸»è¦åšäº†ï¼š
1. æœåŠ¡å™¨ç«¯ï¼Œåœ¨æ¥æ”¶åˆ°äº†`webpack`ç¼–è¯‘å®Œæˆä¹‹åçš„`done`é’©å­ï¼Œç„¶åå‘å®¢æˆ·ç«¯å‘é€äº†ä¸¤ä¸ªæŒ‡ä»¤ï¼š`hash`å’Œ`ok`
2. å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿™ä¸¤ä¸ªæ¶ˆæ¯ï¼Œä¼šåšä»¥ä¸‹æ“ä½œ
  - æ”¹å˜ä»£ç çŠ¶æ€ä¸­çš„`currentHash`ä»¥åŠè°ƒç”¨`reloadApp`æ–¹æ³•
  - åœ¨`reloadApp`ä¸­ï¼Œä½¿ç”¨`webpack`çš„`hotEmitter`çš„`Eventemit`ï¼ŒåŒæ—¶è§¦å‘äº†`webpackHotUpdate`äº‹ä»¶

**`webpackHotUpdate`åˆ°åº•åšäº†ä»€ä¹ˆäº‹å‘¢ï¼Ÿè¿™ä¸ªäº‹ä»¶åœ¨é‚£é‡Œæ³¨å†Œçš„ï¼Ÿ**
è¿™ä¸ªæ—¶å€™å°±éœ€è¦æ‹¿å‡ºä¸€ä¸ªè¢«é—å¿˜çš„æ‰“åŒ…å…¥å£äº†
```
{ entry:
    { index: 
        [
            // ä¸Šé¢è·å–çš„clientEntry
            'xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080',
            // ä¸Šé¢è·å–çš„hotEntry
            'xxx/node_modules/webpack/hot/dev-server.js',
            // å¼€å‘é…ç½®çš„å…¥å£
            './src/index.js'
    	],
    },
}      

```
å³ï¼š`xxx/node_modules/webpack/hot/dev-server.js`

```
	var check = function check() {
		module.hot
			.check(true)
			.then(function(updatedModules) {
				if (!updatedModules) {
					window.location.reload();
					return;
				}

				if (!upToDate()) {
					check();
				}
			})
			.catch(function(err) {
          window.location.reload();
      })
	};
	var hotEmitter = require("./emitter");
	hotEmitter.on("webpackHotUpdate", function(currentHash) {
		lastHash = currentHash;
		if (!upToDate() && module.hot.status() === "idle") {
			check();
		}
	});
```
ä»è¿™é‡Œå¯ä»¥çŸ¥é“ï¼Œå½“è§¦å‘äº†`webpackHotUpdate`äº‹ä»¶ï¼Œå°±ä¼šæ›´æ–°`lastHash`ï¼Œæˆä¸ºæœ€åé¢çš„`hash`å€¼ï¼Œç„¶åè°ƒç”¨`check`å¯åŠ¨æ£€æŸ¥ã€‚ç›´æ¥åˆ·æ–°æ•´ä¸ªé¡µé¢ã€‚è¿™é‡Œå­˜åœ¨äº†ä¸€ä¸ª`module.hot.check(true)`è¿™æ ·çš„äº‹ä»¶ï¼Œè¿™ä¸ªæ–¹æ³•æ¥è‡ªäºçƒ­æ›´æ–°æœ€ä¸»è¦çš„æ’ä»¶`HotModuleReplacementPlugin`


### HotModuleReplacementPlugin
é‚£ä¹ˆ`HotModuleReplacementPlugin`æ˜¯æ€ä¹ˆæ ·æä¾›`module`çš„?å› ä¸º`HotModuleReplacementPlugin`ä½œç”¨äºæµè§ˆå™¨ï¼Œå¯ä»¥çœ‹ä¸€çœ‹æ‰“åŒ…åçš„æ–‡ä»¶ï¼š
å¯ä»¥æ‰¾åˆ°`module`çš„å®šä¹‰ï¼š`hotCreateModule`
```
 var module = installedModules[moduleId] = {
            hot: hotCreateModule(moduleId),
};
// ä»¥åŠ`hotCreateModule`
   function hotCreateModule(moduleId) {
        var hot = {
            check: hotCheck,
        }
        return hot;
    }
// hotCheck
    function hotCheck(apply) {
        hotApplyOnUpdate = apply;
        hotSetStatus("check");

        return hotDownloadManifest(hotRequestTimeout).then(function(update) {
            hotAvailableFilesMap = update.c; // éœ€è¦æ›´æ–°çš„æ–‡ä»¶
            hotUpdateNewHash = update.h; // æ›´æ–°ä¸‹æ¬¡çƒ­æ›´æ–°çš„hashå€¼
            hotSetStatus("prepare"); // å¼€å§‹è¿›å…¥çƒ­æ›´æ–°çš„å‡†å¤‡é˜¶æ®µ

            for(var chunkId in installedChunks)
			      {
              // å»é€šè¿‡jsonpè¯·æ±‚hot-update.js
 				      hotEnsureUpdateChunk(chunkId);
			      }    
        });
    }

function hotDownloadManifest(requestTimeout) {
   var request = new XMLHttpRequest();
   var requestPath = __webpack_require__.p + "" + hotCurrentHash + ".hot-update.json";
   request.open("GET", requestPath, true);
   request.timeout = requestTimeout;
   request.send(null);
}


function hotDownloadUpdateChunk(chunkId) {
var script = document.createElement("script");
script.charset = "utf-8";
script.src = __webpack_require__.p + "" + chunkId + "." + hotCurrentHash + ".hot-update.js";
if (null) script.crossOrigin = null;
document.head.appendChild(script);
}
```


éœ€è¦çŸ¥é“åœ¨è¿™é‡Œï¼Œåšäº†å“ªäº›äº‹æƒ…ï¼š
1. åˆ©ç”¨`ajax`å‘`hotCurrentHash.hot-update.json`å‘é€è¯·æ±‚
2. å¾—åˆ°è¦æ›´æ–°çš„**æ–‡ä»¶**å’Œè¦**æ›´æ–°çš„`hash`æ ‡è¯†**
3. é€šçŸ¥å‡†å¤‡æ›´æ–°
4. ç„¶åæ ¹æ®ä¸åŒçš„`chunkId`åˆ›å»º`script`å»é€šè¿‡`jsonp`è¯·æ±‚ä¸åŒå¯¹åº”çš„`hot-update.js`æ–‡ä»¶
**ä¸ºä»€ä¹ˆè¦ä½¿ç”¨`JSONP`æ¥è¯·æ±‚å‘¢ï¼Ÿ**
1. `JSONP`èƒ½å¤Ÿç›´æ¥æ‰§è¡Œ
2. `hot-update.js`æ–‡ä»¶æ˜¯ä»¥`webpackHotUpdate('chunkId',{....ä»£ç })`åŒ…è£…çš„ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œè¿™æ ·åœ¨è°ƒç”¨äº†`hot-update.js`æ–‡ä»¶çš„åŒæ—¶ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œè¿™æ®µä»£ç 

åœ¨`webpackHotUpdate`å‡½æ•°ä¸»è¦æ˜¯ä¸ºï¼š
1. å°†è¦æ›´æ–°çš„æ¨¡å—`moreModules`å¤åˆ¶ç»™å…¨å±€å˜é‡`hotUpdate`
2. `hotUpdateDownloaded()`æ›´æ–°å½“å‰çŠ¶æ€ä¸º`ready`,å»è°ƒç”¨`hotApply`è¿›è¡Œä»£ç çš„æ›¿æ¢ï¼Œ
```
window["webpackHotUpdate"] = function (chunkId, moreModules) {
    hotAddUpdateChunk(chunkId, moreModules);
} ;


function hotAddUpdateChunk(chunkId, moreModules) {
   for (var moduleId in moreModules) {
 			if (Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {
 				hotUpdate[moduleId] = moreModules[moduleId];
 			}
 		}
    
 		hotUpdateDownloaded();
}

 	function hotUpdateDownloaded() {
 		hotSetStatus("ready");
    var deferred = hotDeferred;
 		hotDeferred = null;
    if (hotApplyOnUpdate) {
 			Promise.resolve()
 				.then(function() {
           // è¿›è¡Œä»£ç çš„æ›¿æ¢
 					return hotApply(hotApplyOnUpdate);
 				})
 				.then(
 					function(result) {
 						deferred.resolve(result);
 					},
 					function(err) {
 						deferred.reject(err);
 					}
 				);
 		} else {
 			var outdatedModules = [];
 			for (var id in hotUpdate) {
 				if (Object.prototype.hasOwnProperty.call(hotUpdate, id)) {
           // è·å–å½“å‰æ—§æ¨¡å—
 					outdatedModules.push(toModuleId(id));
 				}
 			}
 			deferred.resolve(outdatedModules);
 		}
 	}
```


### hotApply(çƒ­æ›´æ–°æœ€é‡è¦çš„åœ°æ–¹ï¼šæ›´æ–°ä»£ç çš„æ›¿æ¢)

```
 	function hotApply(options) {
 		return hotApplyInternal(options);
 	}
```
1. åˆ é™¤è¿‡æœŸæ¨¡å—

```
	var queue = outdatedModules.map(function(id) {
 				return {
 					chain: [id],
 					id: id
 				};
 	});
  while (queue.length > 0) {
 				var queueItem = queue.pop();
 				var moduleId = queueItem.id;
 				var chain = queueItem.chain;
 				module = installedModules[moduleId];
         // åˆ é™¤è¿‡æœŸçš„ä¾èµ–
 				delete outdatedDependencies[parentId];
 				queue.push({
 						chain: chain.concat([parentId]),
 						id: parentId
 			  });
 				}

```

2. å°†æ–°çš„æ¨¡å—æ·»åŠ åˆ°å…¨å±€`modules`

```
appliedUpdate[moduleId] = hotUpdate[moduleId];
	for (moduleId in appliedUpdate) {
 			if (Object.prototype.hasOwnProperty.call(appliedUpdate, moduleId)) {
 				modules[moduleId] = appliedUpdate[moduleId];
 			}
 		}
```

3. é€šè¿‡__webpack_require__æ‰§è¡Œç›¸å…³æ¨¡å—çš„ä»£ç 
```
for (i = 0; i < outdatedSelfAcceptedModules.length; i++) {
    var item = outdatedSelfAcceptedModules[i];
    moduleId = item.module;
    try {
        // æ‰§è¡Œæœ€æ–°çš„ä»£ç 
        __webpack_require__(moduleId);
    } catch (err) {
    }
}
```

### æ€»ç»“

![](https://github.com/zengwmFE/frontEnd-base/blob/master/image/regengxin.png)
#### å¯åŠ¨æœåŠ¡é˜¶æ®µï¼ˆwebpack-dev-server/lib/Server.jsï¼‰
1. è¿è¡Œ`npm run bin`åˆå§‹åŒ–ä¸€ä¸ª`webpack`çš„å®ä¾‹ï¼Œå¯åŠ¨`webpack`çš„ç¼–è¯‘
2. `addEnties`å‡½æ•°ï¼Œå¤„ç†ç”Ÿæˆä¸€ä¸ªæ–°çš„`webpack`çš„`entry`ï¼Œä¾¿äºç”Ÿæˆwebsocketå®¢æˆ·ç«¯ä»£ç ï¼š`node_modules/webpack-dev-server/client/index.js`ä»¥åŠçƒ­æ›´æ–°ä»£ç ï¼š`webpack/hot/dev-server.js`
3. å®Œæˆåå¯ä»¥è®©è¿™ä¸¤å—ä»£ç ä¾èµ–èƒ½å¤Ÿè¢«æ‰“åŒ…åˆ°æœ¬åœ°`bundlejs`,æ¤å…¥åˆ°æµè§ˆå™¨ä¸­å»ï¼Œæœ€ååœ¨æµè§ˆå™¨è¿è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥æ‰¾åˆ°
4. æ¥ä¸‹æ¥æ˜¯ç›‘å¬webpacké˜¶æ®µï¼ˆä¸‹é¢ç»Ÿä¸€æ€»ç»“ï¼‰
5. è°ƒç”¨`express`ç”Ÿæˆä¸€ä¸ªé™æ€æ–‡ä»¶èƒ½å¤Ÿä½¿ç”¨çš„æœåŠ¡å™¨ï¼Œä¾¿äºç”¨`ip`æ¥è®¿é—®æ–‡ä»¶
6. åˆ›å»ºserverä¹‹åï¼Œç´§æ¥ç€ä¼šé€šè¿‡`ws`æˆ–è€…`socketjs`åˆ›å»ºä¸€ä¸ªwebsocketé•¿é“¾æ¥

#### ç›‘å¬webpacké˜¶æ®µ
1. è°ƒç”¨`setUpHooks`å‡½æ•°ï¼Œå¯¹webpackç¼–è¯‘å®Œæˆé˜¶æ®µè¿›è¡Œç›‘å¬ï¼š`done.tap('webpack-dev-server',function(stats){...})`
2. ç­‰ç›‘å¬åˆ°webpackç¼–è¯‘å®Œæˆä¹‹åå°±è°ƒç”¨å›è°ƒï¼š`this._sendStats(this.sockets,this.getStats(stats))`
3. `_sendStats`é€šè¿‡websocketï¼Œå†™å…¥`hash`å’Œ`ok`ä¸¤ä¸ªæŒ‡ä»¤ï¼Œå‘`websocket client`å‘é€ï¼Œ`hash`å‘æµè§ˆå™¨ç«¯å‘é€æœ€æ–°çš„ **`hash`**ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸œè¥¿ï¼‰,`ok`æŒ‡ä»¤é€šçŸ¥å®¢æˆ·ç«¯webpackç¼–è¯‘å®Œæˆäº†ã€‚

4. æ¥ä¸‹æ¥é€šè¿‡`setupDevMiddleware`æ–¹æ³•ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œï¼Œåœ¨è¿™é‡Œæ˜¯åˆ©ç”¨`webpack-dev-middleware`è¿™ä¸ªåº“æ¥è¿›è¡Œæ–‡ä»¶çš„æ“ä½œï¼ˆ**ç¼–è¯‘ï¼Œè¾“å‡ºä»¥åŠç›‘å¬**ï¼‰ï¼Œä»¥ä¾¿è®©`webpack-dev-server`åŠŸèƒ½åˆ†ç¦»å‡ºæ¥ï¼Œä¸“å¿ƒåšå¯åŠ¨æœåŠ¡å’Œå‡†å¤‡å·¥ä½œ
5. `webpack-dev-middle`è°ƒç”¨`compiler.watch`æ–¹æ³•å¯¹æœ¬åœ°æ–‡ä»¶çš„å˜åŒ–è¿›è¡Œç›‘å¬ï¼ˆä¸»è¦é€šè¿‡æ–‡ä»¶çš„æ”¹å˜æ—¶é—´ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ–‡ä»¶å‘ç”Ÿæ”¹å˜ï¼Œå°±èƒ½ç»§ç»­å¯åŠ¨webpackçš„ç¼–è¯‘ï¼‰ï¼ŒåŒæ—¶å°†ç¼–è¯‘æ‰“åŒ…å®Œçš„ä»£ç é€šè¿‡`memory-fs`åº“çš„`setFs(context,compiler)`å†™å…¥å†…å­˜ä¸­,è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ`dist`ç›®å½•æ‰¾ä¸åˆ°çƒ­æ›´æ–°çš„ä»£ç çš„åŸå› 
#### æµè§ˆå™¨æ”¶åˆ°çƒ­æ›´æ–°é€šçŸ¥çš„é˜¶æ®µ
1. åˆ©ç”¨`webpack-dev-server/client/index.js`å†…çš„`websocket æœåŠ¡å™¨`å¯ä»¥æ”¶åˆ°`hash`å’Œ`ok`æŒ‡ä»¤
2. å°†æœ€æ–°çš„`hash`å€¼ä¿å­˜åœ¨`currentHash`ä¸­ï¼Œ`ok`æ–¹æ³•åœ¨å†…éƒ¨è°ƒç”¨äº†`reloadApp(options,status)`
3. `reloadApp`åˆ©ç”¨`webpack/hot/emitter`çš„`emit('webpackHotUpdate')`å»è§¦å‘`webpackHotUpdate`
4. è¿™ä¸ª`webpackHotUpdate`å‡½æ•°çš„æ³¨å†Œåœ¨é‚£é‡Œå‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯`node_modules/webpack/hot/dev-server.js'`ä¸€å¼€å§‹å’Œ`webpack client`å‡½æ•°ä¸€èµ·å†™è¿›æµè§ˆå™¨çš„ã€‚åœ¨ä¸€æ­¥ä¸­ï¼Œ`webpackHotUpdate`çš„**å›è°ƒå‡½æ•°**å°†`currentHash`å­˜æ”¾åœ¨äº†`lastHash`ä¸­ï¼ŒåŒæ—¶è°ƒç”¨äº†`check()`,è¿™ä¸ª`check`æ–¹æ³•ç”±`module.hot.check`æä¾›ï¼Œè¿™ä¸ª`module.hot.check`æ˜¯é‚£é‡Œå‡ºæ¥çš„å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ï¼š`hotModuleReplacementPlugin`


#### `HotModuleReplacement`æ£€æŸ¥ä»£ç æ›´æ–°é˜¶æ®µ
æ‰§è¡Œäº†`module.hot.check`
1. åˆ©ç”¨ä¹‹å‰å¾—åˆ°çš„æœ€æ–°çš„`hash`,è°ƒç”¨`hotDownloadManifest`è¯·æ±‚`hash.hot-update.json`ï¼Œè·å–åˆ°è¦æ›´æ–°çš„ä»£ç çš„æè¿°æ–‡ä»¶ä¿¡æ¯ï¼Œå¹¶è¿›å…¥åˆ°çƒ­æ›´æ–°å‡†å¤‡
2. ç„¶åè°ƒç”¨`hotDownloadUpdateChunk`å‘é€`hash.hot-update.js`ï¼Œé€šè¿‡`JSONP`æ–¹å¼ï¼Œè·å–åˆ°**æœ€æ–°çš„ä»£ç **ï¼Œç„¶åæ ¹æ®`JSONP`çš„ç‰¹æ€§ï¼Œç›´æ¥æ‰§è¡Œäº†`æœ€æ–°çš„ä»£ç å—çš„ä»£ç `ä¸­çš„`webpackHotUpdate`æ–¹æ³•
#### ä»£ç æ›¿æ¢é˜¶æ®µ(window['webpackHotUpdate'])

1. å°†è¦æ›´æ–°çš„æ¨¡å—`moreModules`ä¿å­˜åˆ°å…¨å±€å¯¹è±¡`hotUpdate`,ç„¶åè°ƒç”¨ **`hotApply`**å¼€å§‹è¿›è¡Œæ¨¡å—çš„æ›¿æ¢
2. åˆ é™¤è¿‡æœŸæ¨¡å—ï¼Œå¹¶å°†æ¨¡å—`id`å­˜å‚¨ä¸‹æ¥ï¼Œä»¥é˜²æ­¢æ›´æ–°å¤±è´¥ï¼Œå¯ä»¥è¿›è¡Œå›é€€
3. å°†æ–°çš„æ¨¡å—æ·»åŠ åˆ°`modules`é‡Œé¢
4. è¦çŸ¥é“webpackæ‰“åŒ…åè¦æ‰§è¡Œä»£ç éƒ½æ˜¯é€šè¿‡`bundle`é‡Œé¢çš„`__webpack__require__`æ‰§è¡Œï¼Œåœ¨`hotApply`çš„æœ€åï¼Œè°ƒç”¨`__webpack__require__`ï¼Œå°†`moduleId`ä¼ å…¥ï¼Œæ‰§è¡Œ
`modules[moduleId].call(module.exports, module, module.exports, hotCreateRequire(moduleId));`


#### ç»“æŸé˜¶æ®µ

1. ç„¶åæ‰§è¡Œäº†`module.hot.check`çš„å›è°ƒï¼Œä¸ºäº†å®¹é”™æ‰§è¡Œ`window.location.reload()`,è¿™æ—¶å€™ç»“æŸäº†æ•´ä¸ªè¿‡ç¨‹.æ‰“å°å‡º`[HMR] App is up to date`


### æ€»ç»“

é¦–å…ˆï¼Œä»‹ç»webpack-dev-server:
webpack-dev-server ä¸»è¦åŒ…å«äº†ä¸‰ä¸ªéƒ¨åˆ†ï¼š
1. webpack: è´Ÿè´£ç¼–è¯‘ä»£ç 
2. webpack-dev-middleware: ä¸»è¦è´Ÿè´£æ„å»ºå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼ŒæŠŠwebpackçš„ OutputFileSystem æ›¿æ¢æˆ InMemoryFileSystemã€‚åŒæ—¶ä½œä¸ºExpressçš„ä¸­é—´ä»¶æ‹¦æˆªè¯·æ±‚ï¼Œä»å†…å­˜æ–‡ä»¶ç³»ç»Ÿä¸­æŠŠç»“æœæ‹¿å‡ºæ¥ã€‚
3. expressï¼šè´Ÿè´£æ­å»ºè¯·æ±‚è·¯ç”±æœåŠ¡ã€‚

å…¶æ¬¡ï¼Œä»‹ç»å·¥ä½œæµç¨‹:
1. å¯åŠ¨dev-serverï¼Œwebpackå¼€å§‹æ„å»ºï¼Œåœ¨ç¼–è¯‘æœŸé—´ä¼šå‘ entry æ–‡ä»¶æ³¨å…¥çƒ­æ›´æ–°ä»£ç ï¼›
2. Client é¦–æ¬¡æ‰“å¼€åï¼ŒServer å’Œ Client åŸºäºSocketå»ºç«‹é€šè®¯æ¸ é“ï¼›
3. ä¿®æ”¹æ–‡ä»¶ï¼ŒServer ç«¯ç›‘å¬æ–‡ä»¶å‘é€å˜åŠ¨ï¼Œwebpackå¼€å§‹ç¼–è¯‘ï¼Œç›´åˆ°ç¼–è¯‘å®Œæˆä¼šè§¦å‘"Done"äº‹ä»¶ï¼›
4. Serveré€šè¿‡socket å‘é€æ¶ˆæ¯å‘ŠçŸ¥ Clientï¼›
5. Clientæ ¹æ®Serverçš„æ¶ˆæ¯ï¼ˆhashå€¼å’ŒstateçŠ¶æ€ï¼‰ï¼Œé€šè¿‡ajaxè¯·æ±‚è·å– Server çš„manifestæè¿°æ–‡ä»¶ï¼›
6. Clientå¯¹æ¯”å½“å‰ modules tree ï¼Œå†æ¬¡å‘è¯·æ±‚åˆ° Server ç«¯è·å–æ–°çš„JSæ¨¡å—ï¼›
7. Clientè·å–åˆ°æ–°çš„JSæ¨¡å—åï¼Œä¼šæ›´æ–° modules treeå¹¶æ›¿æ¢æ‰ç°æœ‰çš„æ¨¡å—ï¼›
8. æœ€åè°ƒç”¨ module.hot.accept() å®Œæˆçƒ­æ›´æ–°ï¼›

